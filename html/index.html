<!DOCTYPE html>
<html lang="zh" class="">
<head>
    <meta charset="UTF-8"/>
    <title>æ†¨æ†¨æ¯æ—¥TODO</title>
    <script src="../css/tailwind.css"></script>
    <script>
        tailwind.config = {darkMode: 'class'}
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4 transition-colors
  bg-gradient-to-br from-green-100 via-emerald-100 to-teal-100
  dark:from-gray-900 dark:via-black dark:to-gray-900">

<!-- å¾…åŠé¡µé¢ -->
<div id="todoPage" class="w-full max-w-3xl bg-white/90 dark:bg-black/70 backdrop-blur-md
      rounded-2xl shadow-2xl p-6 flex flex-col min-h-[85vh] border border-gray-200 dark:border-gray-700">


    <!-- æ ‡é¢˜ -->
    <h2 id="pageTitle"
        class="text-center text-3xl font-extrabold mb-4
  bg-gradient-to-r from-green-500 via-emerald-500 to-teal-500
  bg-clip-text text-transparent drop-shadow-lg tracking-wide">
    </h2>


    <!-- æ—¥æœŸ + æ˜ŸæœŸ + æ—¥æœŸé€‰æ‹©å™¨ -->
    <div class="flex items-center justify-center gap-4 mb-6 relative">
        <!-- æ—¥æœŸ + æ˜ŸæœŸ -->


        <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
        <input type="date" id="datePicker"
               class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-600
           bg-white dark:bg-gray-800 dark:text-gray-200 shadow-sm hover:shadow-md
           transition focus:outline-none focus:ring-2 focus:ring-green-400"/>
        <h1 id="date"
            class="text-2xl font-bold bg-gradient-to-r from-green-500 to-green-600
           bg-clip-text text-transparent drop-shadow-lg whitespace-nowrap"></h1>
        <!-- è®¾ç½®æŒ‰é’®å›ºå®šå³ä¸Šè§’ -->
        <button onclick="openSettings()"
                class="absolute top-0 right-0 bg-green-500 text-white rounded-lg p-2 hover:bg-green-600 shadow-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>

        </button>
    </div>


    <!-- æ·»åŠ TODO -->
    <div class="flex flex-col sm:flex-row gap-3 mb-6">
        <input id="newTask" type="text"
               placeholder="è¯·è¾“å…¥ä»Šæ—¥TODOï¼ˆå¯ä»¥ç›´æ¥ç²˜è´´å›¾ç‰‡å“¦~ï¼‰"
               class="flex-1 px-4 py-3 rounded-2xl border border-gray-300
               dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100
               focus:outline-none focus:ring-2 focus:ring-green-400
               shadow-sm"/>
        <select id="priority"
                class="px-3 py-2 rounded-xl border border-gray-300 dark:border-gray-600
               dark:bg-gray-800 dark:text-gray-100 shadow-sm">
            <option value="high">ğŸ”¥ é«˜</option>
            <option value="medium">âš¡ ä¸­</option>
            <option value="low">ğŸŒ± ä½</option>
        </select>
        <button onclick="addTask()"
                class="px-6 py-2 rounded-xl font-semibold text-white
               bg-green-500 hover:bg-green-600 shadow-md transition">
            æ·»åŠ 
        </button>
    </div>

    <!-- ç­›é€‰ + æœç´¢ + ä¸€é”®å®Œæˆ -->
    <div class="flex justify-between items-center mb-4">
        <!-- å·¦è¾¹ å‰ä¸€å¤© -->
        <button onclick="prevDay()"
                class="text-sm text-green-600 dark:text-green-300 hover:underline">â† å‰ä¸€å¤©
        </button>

        <!-- ä¸­é—´ ç­›é€‰å’Œæœç´¢ -->
        <div class="flex gap-2 items-center">
            <div class="flex gap-1">
                <button onclick="setFilter('all')" id="filter-all"
                        class="px-2 py-1 rounded-lg text-xs text-black dark:text-white">å…¨éƒ¨
                </button>
                <button onclick="setFilter('undone')" id="filter-undone"
                        class="px-2 py-1 rounded-lg text-xs text-black dark:text-white">æœªå®Œæˆ
                </button>
                <button onclick="setFilter('done')" id="filter-done"
                        class="px-2 py-1 rounded-lg text-xs text-black dark:text-white">å·²å®Œæˆ
                </button>
            </div>

            <div class="relative">
                <input type="text" id="searchInput" placeholder="æœç´¢..."
                       class="w-20 md:w-24 px-2 py-1 pr-6 rounded-lg border border-gray-300 dark:border-gray-600
           bg-white dark:bg-gray-800 dark:text-gray-100 text-xs
           focus:outline-none focus:ring-1 focus:ring-green-400 focus:w-28 md:focus:w-36 transition-all"/>
                <div class="absolute right-6 top-1.5 text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <!-- æ¸…é™¤æœç´¢æŒ‰é’® -->
                <button id="clearSearch"
                        class="absolute right-1 top-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- å³è¾¹ ä»Šå¤©æŒ‰é’®ï¼ˆå¯éšè—ï¼‰ -->
        <span id="todayBtnWrapper">
        <button onclick="today()"
                class="text-sm text-green-600 dark:text-green-300 hover:underline">ä»Šå¤© â†’
        </button>
    </span>
    </div>


    <!-- çŠ¶æ€ + ä¸€é”®å®Œæˆ -->
    <div class="flex justify-end items-center gap-3 mb-4">
        <div id="stats" class="text-sm text-gray-600 dark:text-gray-300"></div>
        <button onclick="completeAllToday()"
                class="px-3 py-1 text-sm rounded-lg bg-green-500 text-white hover:bg-green-600 transition">å®Œæˆä»Šæ—¥å…¨éƒ¨TODO
        </button>
    </div>

    <!--  æ·»åŠ é¼“åŠ±ä¿¡æ¯å…ƒç´  -->
    <div id="encouragementMessage" class="text-center text-green-600 dark:text-green-400 font-bold text-lg mt-2 hidden">
        ğŸ‰ è¾›è‹¦å•¦ï¼Œä»Šæ—¥TODOéƒ½å®Œæˆå•¦~
    </div>

    <!-- å¾…åŠåˆ—è¡¨ -->
    <ul id="taskList" class="space-y-3 flex-1 overflow-y-auto"></ul>

    <!-- ä½œè€…ä¿¡æ¯ -->
    <div class="mt-6 text-center text-gray-500 dark:text-gray-400 text-sm">
        ä½œè€…ï¼šKingYiFan
    </div>

</div>


<!-- è®¾ç½®é¡µé¢ -->
<div id="settingsPage" class="hidden w-full max-w-md bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
    <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">âš™ï¸ è®¾ç½®</h2>

    <div class="mb-4">
        <label class="block text-sm mb-1 text-gray-700 dark:text-gray-300">é»˜è®¤ä¼˜å…ˆçº§</label>
        <select id="defaultPriority"
                class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-2 dark:bg-gray-700 dark:text-gray-100">
            <option value="high">ğŸ”¥ é«˜</option>
            <option value="medium">âš¡ ä¸­</option>
            <option value="low">ğŸŒ± ä½</option>
        </select>
    </div>

    <div class="mb-4">
        <label class="block text-sm mb-1 text-gray-700 dark:text-gray-300">é»˜è®¤ä¸»é¢˜</label>
        <select id="defaultTheme"
                class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-2 py-2 dark:bg-gray-700 dark:text-gray-100">
            <option value="light">â˜€ï¸ æµ…è‰²</option>
            <option value="dark">ğŸŒ™ æ·±è‰²</option>
        </select>
    </div>
    <div class="mb-6 grid grid-cols-2 gap-3">
        <!-- å¯¼å‡º -->
        <button onclick="exportData()"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-2xl font-semibold
                   bg-gradient-to-r from-blue-400 to-blue-600 text-white shadow-lg
                   hover:scale-105 hover:shadow-xl transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 4v12m0 0l-4-4m4 4l4-4M4 16h16"/>
            </svg>
            å¯¼å‡ºæ•°æ®
        </button>

        <!-- å¯¼å…¥ -->
        <input type="file" id="importFile" accept=".json"
               class="hidden" onchange="importData(event)"/>
        <button onclick="document.getElementById('importFile').click()"
                class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-2xl font-semibold
                   bg-gradient-to-r from-purple-400 to-purple-600 text-white shadow-lg
                   hover:scale-105 hover:shadow-xl transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 12h16m0 0l-4-4m4 4l-4 4"/>
            </svg>
            å¯¼å…¥æ•°æ®
        </button>
    </div>
    <div class="mb-6 grid grid-cols-1 gap-3">
        <!-- å‘¨æœŸä»»åŠ¡æŒ‰é’® -->
        <button onclick="openRecurringModal()"
                class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-3 rounded-2xl font-semibold hover:from-purple-600 hover:to-pink-600 shadow-lg transition flex items-center justify-center gap-2">
            <span>ğŸ”„</span>
            <span>å‘¨æœŸä»»åŠ¡è®¾ç½®</span>
        </button>

        <!-- åˆ é™¤å…¨éƒ¨æ•°æ®æŒ‰é’® -->
        <button onclick="clearAllData()"
                class="w-full bg-red-500 text-white px-4 py-3 rounded-2xl font-semibold hover:bg-red-600 shadow-lg transition">
            ğŸ—‘ï¸ åˆ é™¤å…¨éƒ¨æ•°æ®
        </button>
    </div>


    <div class="flex justify-end">
        <button onclick="closeSettings()"
                class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700">
            è¿”å›å¾…åŠ
        </button>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆ -->
<div id="imgPreview" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
    <img id="previewImg" src="" class="max-h-[90vh] max-w-[90vw] rounded shadow-xl border-4 border-white"/>
</div>

<script>
    const taskListEl = document.getElementById("taskList");
    const newTaskEl = document.getElementById("newTask");
    const priorityEl = document.getElementById("priority");
    const dateEl = document.getElementById("date");
    const weekdayEl = document.getElementById("weekday");
    const datePicker = document.getElementById("datePicker");
    const statsEl = document.getElementById("stats");
    const imgPreview = document.getElementById("imgPreview");
    const previewImg = document.getElementById("previewImg");

    const todoPage = document.getElementById("todoPage");
    const settingsPage = document.getElementById("settingsPage");
    const defaultPriorityEl = document.getElementById("defaultPriority");
    const defaultThemeEl = document.getElementById("defaultTheme");

    let currentDate = new Date();
    let currentFilter = "all";
    const weekdays = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];

    const searchInput = document.getElementById("searchInput");
    const clearSearchBtn = document.getElementById("clearSearch");

    const {ipcRenderer} = require("electron");

    function genId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    }

    function formatDate(d) {
        return d.toISOString().split("T")[0];
    }

    function formatDateTime(d) {
        if (!d) return "";
        const dt = new Date(d);
        const todayStr = formatDate(new Date());
        const dateStr = formatDate(dt);
        if (dateStr === todayStr) {
            return dt.toLocaleTimeString("zh-CN", {hour: "2-digit", minute: "2-digit"});
        } else {
            return `${dateStr} ${dt.toLocaleTimeString("zh-CN", {hour: "2-digit", minute: "2-digit"})}`;
        }
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
        const data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            const raw = localStorage.getItem(key);
            try {
                data[key] = JSON.parse(raw); // å¦‚æœèƒ½è§£æï¼Œè¯´æ˜æ˜¯ JSON
            } catch {
                data[key] = raw; // å¦‚æœä¸èƒ½è§£æï¼Œå°±ç›´æ¥å­˜åŸå§‹å­—ç¬¦ä¸²
            }
        }

        // ç”Ÿæˆå¸¦æ—¥æœŸå’Œè‡ªå¢æ•°å­—çš„æ–‡ä»¶å
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0].replace(/-/g, ''); // YYYYMMDDæ ¼å¼

        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "æ†¨æ†¨TODO_DATA_" + dateStr + ".json";
        a.click();
        URL.revokeObjectURL(url);
        showToast("âœ… æ•°æ®å·²å¯¼å‡º");
    }


    // å¯¼å…¥æ•°æ®
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                for (let key in data) {
                    // è·³è¿‡ä¸»é¢˜å’Œé»˜è®¤ä¼˜å…ˆçº§é…ç½®çš„å¯¼å…¥
                    if (key === "theme" || key === "defaultPriority") {
                        continue;
                    }
                    localStorage.setItem(key, JSON.stringify(data[key]));
                }
                showToast("âœ… æ•°æ®å·²å¯¼å…¥ï¼Œæ­£åœ¨åˆ·æ–°");
                setTimeout(() => location.reload(), 1000);
            } catch (err) {
                alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯");
            }
        };
        reader.readAsText(file);
    }


    // ---------------- TODOç®¡ç† ----------------


    function loadTasks(dateStr) {
        const d = new Date(dateStr);
        const todayStr = formatDate(new Date());
        const yesterdayStr = formatDate(new Date(Date.now() - 86400000)); // æ˜¨å¤©
        const weekday = weekdays[d.getDay()];

        // åŠ¨æ€æ ‡é¢˜
        if (dateStr === todayStr) {
            document.querySelector("h2").textContent = "æ†¨æ†¨ä»Šæ—¥ TODO";
            dateEl.textContent = `${weekday}`;
        } else if (dateStr === yesterdayStr) {
            document.querySelector("h2").textContent = "æ†¨æ†¨æ˜¨æ—¥ TODO";
            dateEl.textContent = `${weekday}`;
        } else {
            document.querySelector("h2").textContent = "æ†¨æ†¨å†å² TODO";
            dateEl.textContent = `${weekday}`;
        }

        // æ§åˆ¶ "ä»Šå¤©" æŒ‰é’®æ˜¾ç¤º
        const todayBtnWrapper = document.getElementById("todayBtnWrapper");

        // å¦‚æœæœç´¢æ¡†è·å¾—ç„¦ç‚¹ï¼Œåˆ™éšè—"ä»Šå¤©"æŒ‰é’®ï¼Œå¦åˆ™æ ¹æ®æ—¥æœŸåˆ¤æ–­
        if (document.activeElement === searchInput) {
            todayBtnWrapper.classList.add("hidden");
        } else {
            // å¦åˆ™æ ¹æ®å½“å‰æ—¥æœŸåˆ¤æ–­
            if (dateStr === todayStr) {
                todayBtnWrapper.classList.add("hidden");
            } else {
                todayBtnWrapper.classList.remove("hidden");
            }
        }

        // è½½å…¥ä»»åŠ¡
        datePicker.value = dateStr;
        let tasks = JSON.parse(localStorage.getItem(dateStr) || "[]");

        // åªåœ¨å±•ç¤ºæ—¶åˆå¹¶å‰ä¸€å¤©æœªå®Œæˆçš„ä»»åŠ¡ï¼Œä¸ä¿å­˜åˆ° localStorage
        const viewingDate = new Date(dateStr);
        const now = new Date();

        // å¯¹äºä»Šå¤©åŠä¹‹å‰çš„æ—¥æœŸï¼Œç»§æ‰¿å†å²æœªå®Œæˆçš„ä»»åŠ¡
        if (viewingDate <= now) {
            // è·å–æ‰€æœ‰å†å²æœªå®Œæˆä»»åŠ¡ï¼ˆé¿å…é€’å½’å¯¼è‡´æ ˆæº¢å‡ºï¼‰
            const getAllUndoneHistoricalTasks = (currentDate) => {
                const result = [];
                const checkedDates = new Set(); // é¿å…é‡å¤æ£€æŸ¥åŒä¸€å¤©
                let checkDate = new Date(currentDate);

                // æœ€å¤šå›æº¯365å¤©ï¼Œé¿å…æ— é™å¾ªç¯
                for (let i = 0; i < 365; i++) {
                    checkDate.setDate(checkDate.getDate() - 1);

                    // å¦‚æœå·²ç»æ£€æŸ¥è¿‡è¿™ä¸€å¤©æˆ–è€…åˆ°äº†æœªæ¥æ—¥æœŸï¼Œåˆ™åœæ­¢
                    const checkDateStr = formatDate(checkDate);
                    if (checkedDates.has(checkDateStr)) {
                        break;
                    }

                    // å¦‚æœæ£€æŸ¥æ—¥æœŸåˆ°äº†æœªæ¥ï¼Œåˆ™åœæ­¢
                    if (checkDate > now) {
                        break;
                    }

                    checkedDates.add(checkDateStr);

                    // è·å–è¿™ä¸€å¤©çš„ä»»åŠ¡
                    let historicalTasks = JSON.parse(localStorage.getItem(checkDateStr) || "[]");
                    let undoneTasks = historicalTasks.filter(t => !t.done);

                    // æ·»åŠ åˆ°ç»“æœä¸­
                    result.push(...undoneTasks);
                }

                return result;
            };

            // è·å–å†å²æœªå®Œæˆä»»åŠ¡
            const historyUndoneTasks = getAllUndoneHistoricalTasks(viewingDate);

            // æ£€æŸ¥é¿å…é‡å¤ï¼ˆæŒ‰ id åˆ¤æ–­ï¼‰
            let existingIds = new Set(tasks.map(t => t.id));
            let newTasks = historyUndoneTasks.filter(t => !existingIds.has(t.id));

            // å°†å†å²æœªå®Œæˆä»»åŠ¡æ·»åŠ åˆ°å½“å‰æ—¥æœŸï¼ˆä»…ç”¨äºå±•ç¤ºï¼‰
            tasks.push(...newTasks);
        }


        // åº”ç”¨æœç´¢è¿‡æ»¤
        let filteredTasks = tasks;
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (searchTerm) {
            filteredTasks = filteredTasks.filter(task =>
                task.text.toLowerCase().includes(searchTerm) ||
                (task.note && task.note.text && task.note.text.toLowerCase().includes(searchTerm))
            );
        }

        // åº”ç”¨çŠ¶æ€è¿‡æ»¤
        if (currentFilter === "done") filteredTasks = filteredTasks.filter(t => t.done);
        if (currentFilter === "undone") filteredTasks = filteredTasks.filter(t => !t.done);

        renderTasks(filteredTasks, tasks); // ç¬¬äºŒä¸ªå‚æ•°æ˜¯å®Œæ•´çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆåŒ…å«ç»§æ‰¿çš„æœªå®Œæˆä»»åŠ¡ï¼‰
    }

    function renderTasks(tasks, allTasksForStats = null) {
        taskListEl.innerHTML = "";
        let filtered = tasks;
        if (currentFilter === "done") filtered = tasks.filter(t => t.done);
        if (currentFilter === "undone") filtered = tasks.filter(t => !t.done);

        // è·å–é¼“åŠ±ä¿¡æ¯å…ƒç´ 
        const encouragementEl = document.getElementById("encouragementMessage");

        if (filtered.length === 0) {
            // è·å–ç”¨äºç»Ÿè®¡çš„ä»»åŠ¡åˆ—è¡¨
            let statsTasks;
            if (allTasksForStats) {
                // å¦‚æœä¼ å…¥äº†å®Œæ•´çš„ä»»åŠ¡åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒè¿›è¡Œç»Ÿè®¡
                statsTasks = allTasksForStats;
            } else {
                // å¦åˆ™ä» localStorage é‡æ–°è·å–
                statsTasks = JSON.parse(localStorage.getItem(formatDate(currentDate)) || "[]");

                // å¦‚æœä»Šå¤©æ˜¯è¿‡å»æˆ–ä»Šå¤©ï¼Œåˆ™ç»§æ‰¿å‰ä¸€å¤©æœªå®Œæˆä»»åŠ¡ï¼ˆä»…ç”¨äºå±•ç¤ºï¼‰
                if (currentDate <= new Date()) {
                    const prevDay = new Date(currentDate);
                    prevDay.setDate(prevDay.getDate() - 1);
                    const prevDayStr = formatDate(prevDay);

                    let previousTasks = JSON.parse(localStorage.getItem(prevDayStr) || "[]");
                    let undoneFromPrevious = previousTasks.filter(t => !t.done);
                    let existingIds = new Set(statsTasks.map(t => t.id));
                    let newTasks = undoneFromPrevious.filter(t => !existingIds.has(t.id));
                    statsTasks.push(...newTasks);
                }
            }

            // æ ¹æ®å½“å‰ç­›é€‰å’Œæœç´¢çŠ¶æ€è®¾ç½®ç»Ÿè®¡æ–‡æœ¬
            let statsText;
            const searchTerm = searchInput.value.trim();
            const totalTasks = statsTasks.length;
            const undoneCount = statsTasks.filter(t => !t.done).length;

            if (searchTerm) {
                // æœ‰æœç´¢æ—¶ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœçš„ç»Ÿè®¡
                if (currentFilter === "done") {
                    statsText = `æœç´¢ç»“æœå·²å®Œæˆ 0 / 0`;
                } else if (currentFilter === "undone") {
                    statsText = `æœç´¢ç»“æœæœªå®Œæˆ 0 / 0`;
                } else {
                    statsText = `æœç´¢ç»“æœæœªå®Œæˆ 0 / 0`;
                }
            } else {
                // æ— æœç´¢æ—¶ï¼Œæ˜¾ç¤ºå®Œæ•´ç»Ÿè®¡
                if (currentFilter === "done") {
                    statsText = `ä»Šæ—¥å·²å®Œæˆ 0 / ${totalTasks}`;
                } else if (currentFilter === "undone") {
                    statsText = `æœªå®Œæˆ (å«å†å²) 0 / ${totalTasks}`;
                } else {
                    statsText = `æœªå®Œæˆ (å«å†å²) ${undoneCount} / ${totalTasks}`;
                }
            }
            statsEl.textContent = statsText;

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼ˆåŸºäºç»Ÿè®¡ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºä»»åŠ¡ï¼‰
            if (undoneCount === 0 && totalTasks > 0) {
                // æ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
                if (encouragementEl) {
                    encouragementEl.classList.remove("hidden");
                }
            } else {
                // éšè—é¼“åŠ±ä¿¡æ¯
                if (encouragementEl) {
                    encouragementEl.classList.add("hidden");
                }
            }
            return;
        }


        const prioOrder = {high: 1, medium: 2, low: 3};
        filtered.sort((a, b) => {
            if (a.done !== b.done) return a.done ? 1 : -1;
            if (!a.done && !b.done) return prioOrder[a.priority] - prioOrder[b.priority];
            if (a.done && b.done) return new Date(b.completedAt) - new Date(a.completedAt);
            return 0;
        });

        filtered.forEach(task => {
            const li = document.createElement("li");
            li.className = "flex flex-col bg-gray-50 dark:bg-gray-800 rounded-lg px-3 py-2 shadow-sm mb-2";

            const row = document.createElement("div");
            row.className = "flex items-center";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = task.done;
            checkbox.className = "mr-3 accent-green-500";
            checkbox.onchange = () => toggleTask(task.id);
            row.appendChild(checkbox);

            // === ä»»åŠ¡å†…å®¹ ===
            const input = document.createElement("input");
            input.type = "text";
            input.value = task.text || "";
            input.className = "flex-1 bg-transparent border-b border-dashed border-gray-400 focus:outline-none "
                + (task.done ? "line-through text-gray-400 dark:text-gray-500" : "text-gray-800 dark:text-gray-100");

            if (task.done) {
                input.readOnly = true; // ç¦æ­¢ä¿®æ”¹
            } else {
                input.onchange = () => updateTaskText(task.id, input.value);
            }
            row.appendChild(input);

            // === ä¼˜å…ˆçº§ ===
            const prioSelect = document.createElement("select");
            prioSelect.className = "ml-2 text-xs rounded px-1 py-0.5 dark:bg-gray-700 dark:text-gray-100";
            ["high", "medium", "low"].forEach(p => {
                const opt = document.createElement("option");
                opt.value = p;
                opt.textContent = p === "high" ? "ğŸ”¥ é«˜" : p === "medium" ? "âš¡ ä¸­" : "ğŸŒ± ä½";
                if (task.priority === p) opt.selected = true;
                prioSelect.appendChild(opt);
            });

            if (task.done) {
                prioSelect.disabled = true; // ç¦æ­¢ä¿®æ”¹
            } else {
                prioSelect.onchange = () => updateTaskPriority(task.id, prioSelect.value);
            }
            row.appendChild(prioSelect);

            // æ·»åŠ å®ŒæˆæŒ‰é’®
            if (!task.done) {
                const completeBtn = document.createElement("button");
                completeBtn.innerHTML = "âœ“";
                completeBtn.className = "ml-2 text-xs px-2 py-1 bg-green-500 text-white rounded hover:bg-green-600";
                completeBtn.title = "æ ‡è®°å®Œæˆ";
                completeBtn.onclick = () => markComplete(task.id);
                row.appendChild(completeBtn);
            }

            // æ·»åŠ åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement("button");
            deleteBtn.innerHTML = "ğŸ—‘ï¸";
            deleteBtn.className = "ml-2 text-xs px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600";
            deleteBtn.title = "åˆ é™¤ä»»åŠ¡";
            deleteBtn.onclick = () => deleteTask(task.id);
            row.appendChild(deleteBtn);

            li.appendChild(row);

            if (task.image) {
                const img = document.createElement("img");
                img.src = task.image;
                img.className = "mt-2 max-h-40 rounded border cursor-pointer";
                img.onclick = () => showImage(task.image, [task.image], 0);
                li.appendChild(img);
            }

            const meta = document.createElement("div");
            meta.className = "text-xs text-gray-500 dark:text-gray-400 mt-1";
            meta.textContent = `åˆ›å»º: ${formatDateTime(task.createdAt)} ${task.done ? " | å®Œæˆ: " + formatDateTime(task.completedAt) : ""}`;
            li.appendChild(meta);

            // ----- å¤‡æ³¨ -----
            const noteBox = document.createElement("div");
            noteBox.className = "mt-2 w-full";

            const noteInput = document.createElement("textarea");
            noteInput.rows = 3;
            noteInput.placeholder = "å¤‡æ³¨(æ”¯æŒç²˜è´´å¤šå¼ å›¾ç‰‡å“¦~)";
            noteInput.value = task.note?.text || "";
            noteInput.className = "w-full text-sm px-3 py-2 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 resize-none";

            if (task.done) {
                noteInput.readOnly = false; // ç¦æ­¢è¾“å…¥
            } else {
                noteInput.onchange = () => updateNoteText(task.id, noteInput.value);
                noteInput.addEventListener("paste", e => {
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.startsWith("image")) {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = evt => addNoteImage(task.id, evt.target.result);
                            reader.readAsDataURL(file);
                            e.preventDefault();
                        }
                    }
                });
            }
            noteBox.appendChild(noteInput);

            const noteImgBox = document.createElement("div");
            noteImgBox.className = "flex flex-wrap gap-2 mt-2";
            (task.note?.images || []).forEach((imgSrc, idx) => {
                const wrapper = document.createElement("div");
                wrapper.className = "relative";

                const img = document.createElement("img");
                img.src = imgSrc;
                img.className = "h-16 rounded border cursor-pointer";
                img.onclick = () => showImage(imgSrc, task.note.images, idx);
                wrapper.appendChild(img);

                if (!task.done) {
                    const delBtn = document.createElement("button");
                    delBtn.textContent = "âœ•";
                    delBtn.className = "absolute top-0 right-0 text-xs bg-red-500 text-white rounded-full px-1";
                    delBtn.onclick = () => removeNoteImage(task.id, idx);
                    wrapper.appendChild(delBtn);
                }

                noteImgBox.appendChild(wrapper);
            });
            noteBox.appendChild(noteImgBox);
            li.appendChild(noteBox);

            taskListEl.appendChild(li);
        });

        // è·å–å½“å‰æ—¥æœŸçš„æ‰€æœ‰ä»»åŠ¡ï¼ˆä¸å¸¦ä»»ä½•ç­›é€‰ï¼‰
        let allTasks = JSON.parse(localStorage.getItem(formatDate(currentDate)) || "[]");

        // å¦‚æœä»Šå¤©æ˜¯è¿‡å»æˆ–ä»Šå¤©ï¼Œåˆ™ç»§æ‰¿å‰ä¸€å¤©æœªå®Œæˆçš„ä»»åŠ¡ï¼ˆä»…ç”¨äºå±•ç¤ºï¼‰
        if (currentDate <= new Date()) {
            const prevDayStr = formatDate(new Date(currentDate));
            const prevDay = new Date(prevDayStr);
            prevDay.setDate(prevDay.getDate() - 1);
            const prevDayStr2 = formatDate(prevDay);

            let previousTasks = JSON.parse(localStorage.getItem(prevDayStr2) || "[]");
            let undoneFromPrevious = previousTasks.filter(t => !t.done);
            let existingIds = new Set(allTasks.map(t => t.id));
            let newTasks = undoneFromPrevious.filter(t => !existingIds.has(t.id));
            allTasks.push(...newTasks);
        }

        // è®¡ç®—æ€»æ•°å’Œå„çŠ¶æ€æ•°é‡
        // è·å–ç”¨äºç»Ÿè®¡çš„ä»»åŠ¡åˆ—è¡¨
        let statsTasks;
        if (allTasksForStats) {
            // å¦‚æœä¼ å…¥äº†å®Œæ•´çš„ä»»åŠ¡åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒè¿›è¡Œç»Ÿè®¡
            statsTasks = allTasksForStats;
        } else {
            // å¦åˆ™ä» localStorage é‡æ–°è·å–
            statsTasks = JSON.parse(localStorage.getItem(formatDate(currentDate)) || "[]");

            // å¦‚æœä»Šå¤©æ˜¯è¿‡å»æˆ–ä»Šå¤©ï¼Œåˆ™ç»§æ‰¿å‰ä¸€å¤©æœªå®Œæˆä»»åŠ¡ï¼ˆä»…ç”¨äºå±•ç¤ºï¼‰
            if (currentDate <= new Date()) {
                const prevDay = new Date(currentDate);
                prevDay.setDate(prevDay.getDate() - 1);
                const prevDayStr = formatDate(prevDay);

                let previousTasks = JSON.parse(localStorage.getItem(prevDayStr) || "[]");
                let undoneFromPrevious = previousTasks.filter(t => !t.done);
                let existingIds = new Set(statsTasks.map(t => t.id));
                let newTasks = undoneFromPrevious.filter(t => !existingIds.has(t.id));
                statsTasks.push(...newTasks);
            }
        }

        // æ ¹æ®å½“å‰ç­›é€‰å’Œæœç´¢çŠ¶æ€è®¾ç½®ç»Ÿè®¡æ–‡æœ¬
        let statsText;
        const searchTerm = searchInput.value.trim();
        const totalTasks = statsTasks.length;
        const doneCount = statsTasks.filter(t => t.done).length;
        const undoneCount = statsTasks.filter(t => !t.done).length;

        if (searchTerm) {
            // æœ‰æœç´¢æ—¶ï¼Œæ˜¾ç¤ºæœç´¢ç»“æœçš„ç»Ÿè®¡
            const searchTotal = tasks.length;
            const searchDone = tasks.filter(t => t.done).length;
            const searchUndone = tasks.filter(t => !t.done).length;

            if (currentFilter === "done") {
                statsText = `æœç´¢ç»“æœå·²å®Œæˆ ${searchDone} / ${searchTotal}`;
            } else if (currentFilter === "undone") {
                statsText = `æœç´¢ç»“æœæœªå®Œæˆ ${searchUndone} / ${searchTotal}`;
            } else {
                statsText = `æœç´¢ç»“æœæœªå®Œæˆ ${searchUndone} / ${searchTotal}`;
            }
        } else {
            // æ— æœç´¢æ—¶ï¼Œæ˜¾ç¤ºå®Œæ•´ç»Ÿè®¡
            if (currentFilter === "done") {
                statsText = `ä»Šæ—¥å·²å®Œæˆ ${doneCount} / ${totalTasks}`;
            } else if (currentFilter === "undone") {
                // å…³é”®ä¿®å¤ï¼šæœªå®Œæˆç­›é€‰ä¸‹æ˜¾ç¤ºæœªå®Œæˆæ•°/æ€»ä»»åŠ¡æ•°
                statsText = `æœªå®Œæˆ (å«å†å²) ${undoneCount} / ${totalTasks}`;
            } else {
                statsText = `æœªå®Œæˆ (å«å†å²) ${undoneCount} / ${totalTasks}`;
            }
        }

        statsEl.textContent = statsText;

        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆï¼ˆåŸºäºç»Ÿè®¡ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºä»»åŠ¡ï¼‰
        if (undoneCount === 0 && totalTasks > 0) {
            // æ˜¾ç¤ºé¼“åŠ±ä¿¡æ¯
            if (encouragementEl) {
                encouragementEl.classList.remove("hidden");
            }
        } else {
            // éšè—é¼“åŠ±ä¿¡æ¯
            if (encouragementEl) {
                encouragementEl.classList.add("hidden");
            }
        }
    }

    // === æ–°å¢å‡½æ•° ===
    function updateTaskText(id, newText) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        tasks = tasks.map(t => t.id === id ? {...t, text: newText} : t);
        localStorage.setItem(taskDate, JSON.stringify(tasks));
    }

    function updateTaskPriority(id, priority) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        tasks = tasks.map(t => t.id === id ? {...t, priority} : t);
        localStorage.setItem(taskDate, JSON.stringify(tasks));
        loadTasks(formatDate(currentDate)); // é‡æ–°åŠ è½½ä»¥ç¡®ä¿æ’åºæ­£ç¡®
    }


    function showToast(msg) {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.classList.remove("hidden");
        // åŠ¨ç”»ï¼šæ·¡å…¥
        setTimeout(() => toast.classList.add("opacity-100"), 10);

        // 2 ç§’åæ·¡å‡º
        setTimeout(() => {
            toast.classList.remove("opacity-100");
            setTimeout(() => toast.classList.add("hidden"), 300);
        }, 2000);
    }

    // åœ¨å…¶ä»–ä»»åŠ¡ç®¡ç†å‡½æ•°é™„è¿‘æ·»åŠ åˆ é™¤å‡½æ•°:
    function deleteTask(id) {
        window.electronAPI.showDeleteDialog().then((confirmed) => {
            if (confirmed) {
                // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
                let taskDate = formatDate(currentDate);
                let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
                let taskExists = tasks.some(t => t.id === id);

                // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
                if (!taskExists) {
                    // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                        if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                            let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                            if (dateTasks.some(t => t.id === id)) {
                                taskDate = key;
                                tasks = dateTasks;
                                break;
                            }
                        }
                    }
                }

                // ä»å®é™…å­˜å‚¨æ—¥æœŸåˆ é™¤ä»»åŠ¡
                tasks = tasks.filter(t => t.id !== id);
                localStorage.setItem(taskDate, JSON.stringify(tasks));

                // é‡æ–°åŠ è½½å½“å‰è§†å›¾çš„ä»»åŠ¡
                loadTasks(formatDate(currentDate));
                showToast("TODOå·²åˆ é™¤");

            }
        }).catch(err => {
            console.error("åˆ é™¤å¯¹è¯æ¡†é”™è¯¯:", err); // âœ… å¢åŠ é”™è¯¯è¾“å‡º
        });
    }


    function saveTasks(tasks) {
        localStorage.setItem(formatDate(currentDate), JSON.stringify(tasks));
    }

    function addTask(imageData = null) {
        const text = newTaskEl.value.trim();
        if (!text && !imageData) return;
        let tasks = JSON.parse(localStorage.getItem(formatDate(currentDate)) || "[]");
        tasks.push({
            id: genId(),
            text,
            image: imageData,
            done: false,
            createdAt: new Date().toISOString(),
            completedAt: null,
            priority: priorityEl.value,
            note: {text: "", images: []}
        });
        saveTasks(tasks);
        newTaskEl.value = "";
        loadTasks(formatDate(currentDate)); // é‡æ–°åŠ è½½ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤ºç»§æ‰¿ä»»åŠ¡
        showToast("TODOå·²æ·»åŠ  ");
    }

    function toggleTask(id) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        tasks = tasks.map(t => t.id === id ? {
            ...t,
            done: !t.done,
            completedAt: !t.done ? new Date().toISOString() : null
        } : t);

        localStorage.setItem(taskDate, JSON.stringify(tasks));
        loadTasks(formatDate(currentDate));
    }

    function markComplete(id) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        // æ ‡è®°ä»»åŠ¡ä¸ºå®Œæˆ
        tasks = tasks.map(t => t.id === id ? {
            ...t,
            done: true,
            completedAt: t.completedAt || new Date().toISOString()
        } : t);

        localStorage.setItem(taskDate, JSON.stringify(tasks));
        loadTasks(formatDate(currentDate));
    }


    // ---- å¤‡æ³¨å¤„ç† ----
    function updateNoteText(id, text) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        // æ›´æ–°å¤‡æ³¨æ–‡æœ¬
        tasks = tasks.map(t => {
            if (t.id === id) {
                return {...t, note: {...(t.note || {images: []}), text}};
            }
            return t;
        });

        localStorage.setItem(taskDate, JSON.stringify(tasks));
    }

    function addNoteImage(id, imgData) {
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }
        tasks = tasks.map(t => {
            if (t.id === id) {
                const images = t.note?.images || [];
                return {...t, note: {...(t.note || {text: ""}), images: [...images, imgData]}};
            }
            return t;
        });
        localStorage.setItem(taskDate, JSON.stringify(tasks));
        loadTasks(formatDate(currentDate));
    }

    function removeNoteImage(id, idx) {
        // æ‰¾åˆ°ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        let taskDate = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(taskDate) || "[]");
        let taskExists = tasks.some(t => t.id === id);

        // å¦‚æœåœ¨å½“å‰æ—¥æœŸæ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥æ‰¾ä»»åŠ¡å®é™…å­˜å‚¨çš„æ—¥æœŸ
        if (!taskExists) {
            // éå†æ‰€æœ‰ localStorage é¡¹æŸ¥æ‰¾ä»»åŠ¡
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ—¥æœŸæ ¼å¼çš„é”®
                if (key && /^\d{4}-\d{2}-\d{2}$/.test(key)) {
                    let dateTasks = JSON.parse(localStorage.getItem(key) || "[]");
                    if (dateTasks.some(t => t.id === id)) {
                        taskDate = key;
                        tasks = dateTasks;
                        break;
                    }
                }
            }
        }

        tasks = tasks.map(t => {
            if (t.id === id) {
                const images = [...(t.note?.images || [])];
                images.splice(idx, 1);
                return {...t, note: {...(t.note || {text: ""}), images}};
            }
            return t;
        });
        // ä¿å­˜åˆ°æ­£ç¡®çš„æ—¥æœŸä½ç½®
        localStorage.setItem(taskDate, JSON.stringify(tasks));
        // é‡æ–°åŠ è½½å½“å‰è§†å›¾çš„ä»»åŠ¡
        loadTasks(formatDate(currentDate));
    }

    function completeAllToday() {
        let dateStr = formatDate(currentDate);
        let tasks = JSON.parse(localStorage.getItem(dateStr) || "[]");
        const now = new Date().toISOString();

        let undoneTasks = tasks.filter(t => !t.done).length;
        if (undoneTasks === 0) {
            showToast("ğŸ‰ ä»Šå¤©æ²¡æœ‰æœªå®Œæˆçš„TODOï¼");
            return;
        }

        tasks = tasks.map(t => t.done ? t : {...t, done: true, completedAt: now});
        saveTasks(tasks);
        loadTasks(formatDate(currentDate)); // é‡æ–°åŠ è½½ä»¥ç¡®ä¿æ­£ç¡®æ˜¾ç¤ºç»§æ‰¿ä»»åŠ¡

        showToast(`ä¸€é”®å®Œæˆï¼Œå…±å®Œæˆä»Šæ—¥ ${undoneTasks} ä¸ªTODO`);
    }


    // ---------------- é¡µé¢ & è®¾ç½® ----------------
    function prevDay() {
        currentDate.setDate(currentDate.getDate() - 1);
        loadTasks(formatDate(currentDate));
    }

    function today() {
        currentDate = new Date();
        loadTasks(formatDate(currentDate));
    }

    function setFilter(f) {
        currentFilter = f;
        document.querySelectorAll("[id^=filter-]").forEach(btn =>
            btn.classList.remove("bg-green-200", "dark:bg-green-700", "bg-lime-200", "dark:bg-lime-700", "bg-red-200", "dark:bg-red-700"));
        if (f === "all") document.getElementById("filter-all").classList.add("bg-green-200", "dark:bg-green-700", "text-black", "dark:text-white");
        if (f === "done") document.getElementById("filter-done").classList.add("bg-lime-200", "dark:bg-lime-700", "text-black", "dark:text-white");
        if (f === "undone") document.getElementById("filter-undone").classList.add("bg-red-200", "dark:bg-red-700", "text-black", "dark:text-white");

        // é‡æ–°åŠ è½½ä»»åŠ¡ä»¥åº”ç”¨ç­›é€‰å™¨å’Œå½“å‰æœç´¢
        loadTasks(formatDate(currentDate));
    }

    function openSettings() {
        todoPage.classList.add("hidden");
        settingsPage.classList.remove("hidden");
        defaultPriorityEl.value = localStorage.getItem("defaultPriority") || "medium";
        defaultThemeEl.value = localStorage.getItem("theme") || "light";
    }

    defaultThemeEl.addEventListener("change", () => {
        localStorage.setItem("theme", defaultThemeEl.value);
        if (defaultThemeEl.value === "dark") {
            document.documentElement.classList.add("dark");
        } else {
            document.documentElement.classList.remove("dark");
        }
    });

    function closeSettings() {
        localStorage.setItem("defaultPriority", defaultPriorityEl.value);
        localStorage.setItem("theme", defaultThemeEl.value);

        if (defaultThemeEl.value === "dark") document.documentElement.classList.add("dark");
        else document.documentElement.classList.remove("dark");

        // åŒæ­¥ä¼˜å…ˆçº§åˆ°ä¸»é¡µé¢
        priorityEl.value = defaultPriorityEl.value;

        todoPage.classList.remove("hidden");
        settingsPage.classList.add("hidden");
        loadTasks(formatDate(currentDate));
    }

    function clearAllData() {
        window.electronAPI.showClearDialog().then((confirmed) => {
            if (confirmed) {
                // åªåˆ é™¤å¾…åŠäº‹é¡¹æ•°æ®ï¼Œä¿ç•™ä¸»é¢˜å’Œé»˜è®¤ä¼˜å…ˆçº§é…ç½®
                const theme = localStorage.getItem("theme");
                const defaultPriority = localStorage.getItem("defaultPriority");

                localStorage.clear();

                if (theme) {
                    localStorage.setItem("theme", theme);
                }
                if (defaultPriority) {
                    localStorage.setItem("defaultPriority", defaultPriority);
                }

                location.reload();
            }
        });
    }

    // ---------------- å›¾ç‰‡é¢„è§ˆ ----------------
    let previewImages = [];
    let currentPreviewIndex = 0;

    function showImage(src) {
        ipcRenderer.send("open-image-viewer", src);
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    imgPreview.onclick = e => {
        if (e.target === imgPreview) { // åªç‚¹èƒŒæ™¯æ—¶æ‰å…³é—­
            imgPreview.classList.add("hidden");
        }
    };

    // é”®ç›˜æ§åˆ¶
    document.addEventListener("keydown", e => {
        if (imgPreview.classList.contains("hidden")) return;

        if (e.key === "Escape") {
            imgPreview.classList.add("hidden");
        }
        if (e.key === "ArrowLeft") {
            currentPreviewIndex = (currentPreviewIndex - 1 + previewImages.length) % previewImages.length;
            previewImg.src = previewImages[currentPreviewIndex];
        }
        if (e.key === "ArrowRight") {
            currentPreviewIndex = (currentPreviewIndex + 1) % previewImages.length;
            previewImg.src = previewImages[currentPreviewIndex];
        }
    });


    imgPreview.onclick = () => imgPreview.classList.add("hidden");
    newTaskEl.addEventListener("paste", e => {
        const items = e.clipboardData.items;
        for (let item of items) {
            if (item.type.startsWith("image")) {
                const file = item.getAsFile();
                const reader = new FileReader();
                reader.onload = evt => addTask(evt.target.result);
                reader.readAsDataURL(file);
                e.preventDefault();
            }
        }
    });

    // ---------------- åˆå§‹åŒ– ----------------
    newTaskEl.addEventListener("keydown", e => {
        if (e.key === "Enter") addTask();
    });
    datePicker.addEventListener("change", function () {
        currentDate = new Date(this.value);
        loadTasks(formatDate(currentDate));
    });
    if (localStorage.getItem("theme") === "dark") document.documentElement.classList.add("dark");
    priorityEl.value = localStorage.getItem("defaultPriority") || "medium";
    loadTasks(formatDate(currentDate));
    setFilter("all");

    // æœç´¢åŠŸèƒ½
    searchInput.addEventListener("input", () => {
        // æ ¹æ®è¾“å…¥æ¡†æ˜¯å¦æœ‰å†…å®¹æ¥æ˜¾ç¤º/éšè—æ¸…é™¤æŒ‰é’®
        if (searchInput.value.trim() !== "") {
            clearSearchBtn.classList.remove("hidden");
        } else {
            clearSearchBtn.classList.add("hidden");
        }
        loadTasks(formatDate(currentDate)); // é‡æ–°åŠ è½½ä»¥åº”ç”¨æœç´¢è¿‡æ»¤
    });


    // æ¸…é™¤æœç´¢
    clearSearchBtn.addEventListener("click", () => {
        searchInput.value = "";
        clearSearchBtn.classList.add("hidden");
        loadTasks(formatDate(currentDate)); // é‡æ–°åŠ è½½ä»¥æ¸…é™¤æœç´¢è¿‡æ»¤
    });
    // æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶æ¢å¤ä»Šå¤©æŒ‰é’®çŠ¶æ€
    searchInput.addEventListener("blur", () => {
        // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç¡®ä¿å¤±å»ç„¦ç‚¹åå†åˆ¤æ–­
        setTimeout(() => {
            const todayBtnWrapper = document.getElementById("todayBtnWrapper");
            const todayStr = formatDate(new Date());
            const dateStr = formatDate(currentDate);

            // æ ¹æ®å½“å‰æ—¥æœŸåˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä»Šå¤©æŒ‰é’®
            if (dateStr === todayStr) {
                todayBtnWrapper.classList.add("hidden");
            } else {
                todayBtnWrapper.classList.remove("hidden");
            }
        }, 10);
    });

    // æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶éšè—ä»Šå¤©æŒ‰é’®
    searchInput.addEventListener("focus", () => {
        const todayBtnWrapper = document.getElementById("todayBtnWrapper");
        todayBtnWrapper.classList.add("hidden");
    });

    //æ·»åŠ å‘¨æœŸä»»åŠ¡
    function openRecurringModal() {
        window.location.href = 'recurring.html';
    }
</script>
<!-- ä¸­é—´æç¤ºæ¡† -->
<div id="toast"
     class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
         bg-black/80 text-white px-6 py-3 rounded-2xl shadow-lg hidden z-50
         text-lg font-semibold opacity-0 transition-opacity duration-300">
</div>
</body>
</html>
